<!doctype html> <html lang=en> <head> <meta charset=utf-8 /> <meta http-equiv=X-UA-Compatible content='IE=edge;chrome=1'/> <meta name=viewport content="width=device-width, initial-scale=1, shrink-to-fit=no"> <title>7fff - ActiveRecord: Migrating habtm to model table suitable for has_many :through</title> <link rel=alternate type="application/atom+xml" title="Atom Feed" href="/feed.xml"/> <link href="../../../assets/stylesheets/application-47b0fa16.css" rel=stylesheet /> <link href="../../../assets/stylesheets/syntax-a7a497f1.css" rel=stylesheet /> <!--[if lt IE 9]><script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script> <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script><![endif]--> </head> <body> <nav class="navbar navbar-expand-lg navbar-light bg-light"> <a class=navbar-brand href="/">7fff</a> <button class=navbar-toggler type=button data-toggle=collapse data-target="#navbarSupportedContent" aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation"> <span class=navbar-toggler-icon></span> </button> <div class="collapse navbar-collapse" id=navbarSupportedContent> <ul class="navbar-nav mr-auto"> <li class=nav-item> <a class=nav-link href="/about">About <span class=sr-only>(current)</span></a> </li> <li class=nav-item> <a class=nav-link href="/publickey">Key</a> </li> <li class=nav-item> <a class=nav-link href="https://wiki.7fff.com">Wiki</a> </li> </ul> <form class="form-inline my-2 my-lg-0"> <input id=st-search-input class="form-control mr-sm-2" type=search title=search aria-label=Search> <button class="btn btn-outline-success my-2 my-sm-0" type=submit>Search</button> </form> <div id=st-results-container></div> <script>
          var Swiftype = window.Swiftype || {};
          (function() {
            Swiftype.key = 'dDpJ_rUeRKZTo7sGL9JQ';
            Swiftype.inputElement = '#st-search-input';
            Swiftype.resultContainingElement = '#st-results-container';
            Swiftype.attachElement = '#st-search-input';
            Swiftype.renderStyle = "overlay";
            var script = document.createElement('script');
            script.type = 'text/javascript';
            script.async = true;
            script.src = "//swiftype.com/embed.js";
            var entry = document.getElementsByTagName('script')[0];
            entry.parentNode.insertBefore(script, entry);
          }());
        </script> </div> </nav> <div class=container-fluid> <h1>ActiveRecord: Migrating habtm to model table suitable for has_many :through <small> by jgn on Wednesday, October 31, 2007 in <a href="../../../category/rails/">Rails</a> </small> </h1> <p>[Ha, ha, ActiveRecord has the last laugh, and this is much easier than I thought. The Rails Wiki must have been wrong, or it must have been that you couldn&#39;t add a primary key in an earlier version of AR.]</p> <p>ActiveRecord will facilitate many:many relationships across a plain join table that doesn&#39;t have a primary key. This is called &quot;has and belongs to many.&quot; It turns out that it is ~~hard~~ easy to convert this into a join table where the join table itself represents something.</p> <p>The example here is a bookmarking application like del.icio.us: you have many users with many links (and <em>vice versa</em>), and model those things as a User class and a Link class. Each User has and belongs to many Links; each Link has and belongs to many Users. As a first cut, you might put the title of the URL in the Link class. So John and Amy might each have a reference to the same link. Note in this model, a catch is that since they share that same Link, it is problematic that the title is on the Link class. Because now they must share that title. Our model prevents one of them from saving his or her link for the NY Times with a personal title such as &quot;The Yankee-Loving New York Times,&quot; or some other appropriate moniker. So with that issue in mind, we would like to migrate our schema so that there is a Bookmark class in between User and Link. Now we will put the title in Bookmark, and let the User edit it. If we do this, Amy and John can have bookmarks for the same link (the URL being represented in the Link class) but different titles (in the Bookmark class).</p> <p>Let&#39;s take it from the top, shall we? In the original model, if you have a model User, and a model Link, and you want to have a many:many relationship, you can define an association for each one of the form has_and_belongs_to_many :links (and the reverse). Then you create a join table like the following (note the suppression of the primary key):</p> <p>[source language=&#39;ruby&#39;] class CreateLinksUsers false do |t| t.column :link_id, :integer t.column :user_id, :integer end end def self.down drop_table :links_users end end [/source]</p> <p>As time proceeds, we discover that we are interested in adding some extra data that should go on the join table. For instance, we might want the time/date when it was added, or notes specific to the relationship between the link and the user... Or a title, as above. At this point we would need to model it as a first-class (so to speak) ActiveRecord class and use the associations has_many :through for the &quot;endpoints&quot; and belongs_to for the in-between class.</p> <p>Sadly, if you are like me, you might read the Rails Wiki pages before you do anything, and you would read the following which is all wrong:</p> <p>~~Unfortunately, this is tricky because ActiveRecord does not model the original links_users table: It is purely a vehicle for the habtm association. We might think we could rename the table to, say, :bookmarks, and then add a primary key . . . But ActiveRecord does not allow one to add a primary key column to an already-existing table:~~</p> <blockquote> <p>Note: The API doc on add_column refers to column_types which say that it can be of type :primary_key. This is not true. add_column cannot use :primary_key as a type_ (see <a href="http://wiki.rubyonrails.org/rails/pages/UsingMigrations">Rails Wiki, Using Migrations</a>)</p> </blockquote> <p>So . . . What to do? One way ~~The answer~~ is to create a new bookmarks table, and then model it inside the migration. Loop over your users and links to extract the ids, and add them to the bookmarks. The reverse is much easier: Now you can just drop the primary key and rename the table back to links_users:</p> <p>[source language=&#39;ruby&#39;] class CreateBookmarks l.id, :user_id =&gt; u.id ) end end </p> <p>drop_table :links_users print &quot;Change your associations for User and Link to has_many :through =&gt; :bookmarks&quot;</p> <p>end</p> <p>def self.down remove_column :bookmarks, :id rename_table :bookmarks, :links_users print &quot;Change your associations for User and Link to has_and_belongs_to_many&quot; end</p> <p>end [/source]</p> <p>But it can be even easier than that: You might also just add the new primary key going up, and drop it going down:</p> <p>[source language=&#39;ruby&#39;] class CreateBookmarks :bookmarks&quot;</p> <p>end</p> <p>def self.down remove_column :bookmarks, :id rename_table :bookmarks, :links_users print &quot;Change your associations for User and Link to has_and_belongs_to_many&quot; end</p> <p>end [/source]</p> <p>Yet that&#39;s not all. ~~If you want to preserve data across this migration, you will likely find that information will be lost when you move from the newly-modeled table to the table without the primary key. This is because it is very common to enforce uniqueness on one of the keys in the habtm join table. But when you model a classic many:many join, you probably won&#39;t do that. ~~ You may find that going &quot;down&quot; that you have added data to the has_many :through version that is incompatible with what you had in your habtm model; in which case you are going to have to define a rule to re-organize the data.</p> <div id=disqus_thread></div> <script>
//<![CDATA[
                  var disqus_shortname = '7fff';
          
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
//]]>
</script> <noscript>Please enable JavaScript to view the <a href='http://disqus.com/?ref_noscript'>comments powered by Disqus.</a></noscript> <a href='http://disqus.com' class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a> <script>
//<![CDATA[
    var disqus_shortname = '7fff';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
//]]>
</script> </div> <hr/> <div class="container-fluid footer-padding"> <aside> <h4>Recent Posts</h4> <ol> <li><a href="../../../2025/04/dissertating/">Dissertating</a> <span>(April 25, 2025)</span></li> <li><a href="../../../2025/04/prompting-claude-to-write-gdpr-questions/">Prompting Claude to write GDPR questions</a> <span>(April 16, 2025)</span></li> <li><a href="../../../2025/01/radio-buttons-checkboxes-affirmative-choices-and-consents/">Radio buttons, checkboxes, affirmative choices, and consents</a> <span>(January 3, 2025)</span></li> <li><a href="../../../2024/12/how-to-reverse-revert-some-thor-actions/">How to reverse (revert) some Thor actions</a> <span>(December 4, 2024)</span></li> <li><a href="../../../2024/12/arrays-are-rarely-the-natural-choice-in-bash-use-files/">Arrays are rarely the natural choice in bash; use files</a> <span>(December 2, 2024)</span></li> <li><a href="../../../2024/09/using-google-apps-script-to-convert-a-word-document-to-google-docs/">Using Google Apps Script to convert a Word document to Google Docs</a> <span>(September 9, 2024)</span></li> </ol> <h4>Categories</h4> <a href="../../../category/ai/" class="btn btn-default btn-xs">AI <span class='badge badge-secondary'>1</span></a> <a href="../../../category/announcements/" class="btn btn-default btn-xs">Announcements <span class='badge badge-secondary'>4</span></a> <a href="../../../category/annoyance/" class="btn btn-default btn-xs">Annoyance <span class='badge badge-secondary'>8</span></a> <a href="../../../category/cipp-e/" class="btn btn-default btn-xs">CIPP/E <span class='badge badge-secondary'>1</span></a> <a href="../../../category/claude/" class="btn btn-default btn-xs">Claude <span class='badge badge-secondary'>1</span></a> <a href="../../../category/code/" class="btn btn-default btn-xs">Code <span class='badge badge-secondary'>23</span></a> <a href="../../../category/college-visits/" class="btn btn-default btn-xs">College Visits <span class='badge badge-secondary'>7</span></a> <a href="../../../category/colleges/" class="btn btn-default btn-xs">Colleges <span class='badge badge-secondary'>7</span></a> <a href="../../../category/consulting/" class="btn btn-default btn-xs">Consulting <span class='badge badge-secondary'>1</span></a> <a href="../../../category/data/" class="btn btn-default btn-xs">Data <span class='badge badge-secondary'>1</span></a> <a href="../../../category/dining/" class="btn btn-default btn-xs">Dining <span class='badge badge-secondary'>1</span></a> <a href="../../../category/facebook/" class="btn btn-default btn-xs">Facebook <span class='badge badge-secondary'>1</span></a> <a href="../../../category/gdpr/" class="btn btn-default btn-xs">GDPR <span class='badge badge-secondary'>1</span></a> <a href="../../../category/getting-rid-of-old-drafts-series/" class="btn btn-default btn-xs">Getting-rid-of-old-drafts-series <span class='badge badge-secondary'>1</span></a> <a href="../../../category/google-apps/" class="btn btn-default btn-xs">Google Apps <span class='badge badge-secondary'>1</span></a> <a href="../../../category/google-apps-script/" class="btn btn-default btn-xs">Google Apps Script <span class='badge badge-secondary'>1</span></a> <a href="../../../category/health/" class="btn btn-default btn-xs">Health <span class='badge badge-secondary'>2</span></a> <a href="../../../category/iora/" class="btn btn-default btn-xs">Iora <span class='badge badge-secondary'>1</span></a> <a href="../../../category/javascript/" class="btn btn-default btn-xs">JavaScript <span class='badge badge-secondary'>1</span></a> <a href="../../../category/kendall-square/" class="btn btn-default btn-xs">Kendall Square <span class='badge badge-secondary'>4</span></a> <a href="../../../category/liberal-arts/" class="btn btn-default btn-xs">Liberal Arts <span class='badge badge-secondary'>7</span></a> <a href="../../../category/listening/" class="btn btn-default btn-xs">Listening <span class='badge badge-secondary'>13</span></a> <a href="../../../category/management/" class="btn btn-default btn-xs">Management <span class='badge badge-secondary'>2</span></a> <a href="../../../category/middleman/" class="btn btn-default btn-xs">Middleman <span class='badge badge-secondary'>3</span></a> <a href="../../../category/prompting/" class="btn btn-default btn-xs">Prompting <span class='badge badge-secondary'>1</span></a> <a href="../../../category/rails/" class="btn btn-default btn-xs">Rails <span class='badge badge-secondary'>11</span></a> <a href="../../../category/reading/" class="btn btn-default btn-xs">Reading <span class='badge badge-secondary'>43</span></a> <a href="../../../category/reviews/" class="btn btn-default btn-xs">Reviews <span class='badge badge-secondary'>33</span></a> <a href="../../../category/ruby/" class="btn btn-default btn-xs">Ruby <span class='badge badge-secondary'>20</span></a> <a href="../../../category/security/" class="btn btn-default btn-xs">Security <span class='badge badge-secondary'>1</span></a> <a href="../../../category/small-liberal-arts-colleges/" class="btn btn-default btn-xs">Small Liberal Arts Colleges <span class='badge badge-secondary'>7</span></a> <a href="../../../category/social-media/" class="btn btn-default btn-xs">Social Media <span class='badge badge-secondary'>1</span></a> <a href="../../../category/startup-cto-bookshelf/" class="btn btn-default btn-xs">Startup CTO Bookshelf <span class='badge badge-secondary'>2</span></a> <a href="../../../category/teaching/" class="btn btn-default btn-xs">Teaching <span class='badge badge-secondary'>2</span></a> <a href="../../../category/technology/" class="btn btn-default btn-xs">Technology <span class='badge badge-secondary'>106</span></a> <a href="../../../category/time-management/" class="btn btn-default btn-xs">Time Management <span class='badge badge-secondary'>2</span></a> <a href="../../../category/travel/" class="btn btn-default btn-xs">Travel <span class='badge badge-secondary'>10</span></a> <a href="../../../category/uncategorized/" class="btn btn-default btn-xs">Uncategorized <span class='badge badge-secondary'>18</span></a> <a href="../../../category/values/" class="btn btn-default btn-xs">Values <span class='badge badge-secondary'>1</span></a> <a href="../../../category/wasting-time/" class="btn btn-default btn-xs">Wasting Time <span class='badge badge-secondary'>1</span></a> <a href="../../../category/bash/" class="btn btn-default btn-xs">bash <span class='badge badge-secondary'>1</span></a> <a href="../../../category/hacks/" class="btn btn-default btn-xs">hacks <span class='badge badge-secondary'>1</span></a> <a href="../../../category/management/" class="btn btn-default btn-xs">management <span class='badge badge-secondary'>1</span></a> <a href="../../../category/me/" class="btn btn-default btn-xs">me <span class='badge badge-secondary'>1</span></a> <a href="../../../category/programming/" class="btn btn-default btn-xs">programming <span class='badge badge-secondary'>3</span></a> <a href="../../../category/reading/" class="btn btn-default btn-xs">reading <span class='badge badge-secondary'>3</span></a> <a href="../../../category/ruby/" class="btn btn-default btn-xs">ruby <span class='badge badge-secondary'>1</span></a> <h4>Tags</h4> <a href="/tag/apple/" class="btn btn-default btn-xs">Apple <span class='badge badge-secondary'>1</span></a> <a href="/tag/apple-watch/" class="btn btn-default btn-xs">Apple Watch <span class='badge badge-secondary'>1</span></a> <a href="/tag/bard-college/" class="btn btn-default btn-xs">Bard College <span class='badge badge-secondary'>1</span></a> <a href="/tag/barnard-college/" class="btn btn-default btn-xs">Barnard College <span class='badge badge-secondary'>1</span></a> <a href="/tag/bates-college/" class="btn btn-default btn-xs">Bates College <span class='badge badge-secondary'>2</span></a> <a href="/tag/cissp/" class="btn btn-default btn-xs">CISSP <span class='badge badge-secondary'>1</span></a> <a href="/tag/carleton-college/" class="btn btn-default btn-xs">Carleton College <span class='badge badge-secondary'>1</span></a> <a href="/tag/claude/" class="btn btn-default btn-xs">Claude <span class='badge badge-secondary'>1</span></a> <a href="/tag/college/" class="btn btn-default btn-xs">College <span class='badge badge-secondary'>1</span></a> <a href="/tag/coursera/" class="btn btn-default btn-xs">Coursera <span class='badge badge-secondary'>1</span></a> <a href="/tag/global-entry/" class="btn btn-default btn-xs">Global Entry <span class='badge badge-secondary'>1</span></a> <a href="/tag/google-apps/" class="btn btn-default btn-xs">Google Apps <span class='badge badge-secondary'>1</span></a> <a href="/tag/google-docs/" class="btn btn-default btn-xs">Google Docs <span class='badge badge-secondary'>1</span></a> <a href="/tag/grinnell-college/" class="btn btn-default btn-xs">Grinnell College <span class='badge badge-secondary'>1</span></a> <a href="/tag/javascript/" class="btn btn-default btn-xs">JavaScript <span class='badge badge-secondary'>1</span></a> <a href="/tag/microsoft-word/" class="btn btn-default btn-xs">Microsoft Word <span class='badge badge-secondary'>1</span></a> <a href="/tag/ny-times/" class="btn btn-default btn-xs">NY Times <span class='badge badge-secondary'>1</span></a> <a href="/tag/paperbacks/" class="btn btn-default btn-xs">Paperbacks <span class='badge badge-secondary'>1</span></a> <a href="/tag/qardio/" class="btn btn-default btn-xs">Qardio <span class='badge badge-secondary'>1</span></a> <a href="/tag/reading/" class="btn btn-default btn-xs">Reading <span class='badge badge-secondary'>1</span></a> <a href="/tag/reviews/" class="btn btn-default btn-xs">Reviews <span class='badge badge-secondary'>1</span></a> <a href="/tag/tsa/" class="btn btn-default btn-xs">TSA <span class='badge badge-secondary'>1</span></a> <a href="/tag/tsa-pre/" class="btn btn-default btn-xs">TSA Pre <span class='badge badge-secondary'>1</span></a> <a href="/tag/thor/" class="btn btn-default btn-xs">Thor <span class='badge badge-secondary'>1</span></a> <a href="/tag/vassar-college/" class="btn btn-default btn-xs">Vassar College <span class='badge badge-secondary'>1</span></a> <a href="/tag/watch/" class="btn btn-default btn-xs">Watch <span class='badge badge-secondary'>1</span></a> <a href="/tag/activerecord/" class="btn btn-default btn-xs">activerecord <span class='badge badge-secondary'>1</span></a> <a href="/tag/anatomy/" class="btn btn-default btn-xs">anatomy <span class='badge badge-secondary'>1</span></a> <a href="/tag/arrays/" class="btn btn-default btn-xs">arrays <span class='badge badge-secondary'>1</span></a> <a href="/tag/bash/" class="btn btn-default btn-xs">bash <span class='badge badge-secondary'>1</span></a> <a href="/tag/billing/" class="btn btn-default btn-xs">billing <span class='badge badge-secondary'>1</span></a> <a href="/tag/boxen/" class="btn btn-default btn-xs">boxen <span class='badge badge-secondary'>2</span></a> <a href="/tag/burton/" class="btn btn-default btn-xs">burton <span class='badge badge-secondary'>1</span></a> <a href="/tag/categories/" class="btn btn-default btn-xs">categories <span class='badge badge-secondary'>1</span></a> <a href="/tag/dissection/" class="btn btn-default btn-xs">dissection <span class='badge badge-secondary'>1</span></a> <a href="/tag/files/" class="btn btn-default btn-xs">files <span class='badge badge-secondary'>1</span></a> <a href="/tag/invoicing/" class="btn btn-default btn-xs">invoicing <span class='badge badge-secondary'>1</span></a> <a href="/tag/literature/" class="btn btn-default btn-xs">literature <span class='badge badge-secondary'>1</span></a> <a href="/tag/lyly/" class="btn btn-default btn-xs">lyly <span class='badge badge-secondary'>1</span></a> <a href="/tag/mobile-apps/" class="btn btn-default btn-xs">mobile apps <span class='badge badge-secondary'>1</span></a> <a href="/tag/nashe/" class="btn btn-default btn-xs">nashe <span class='badge badge-secondary'>1</span></a> <a href="/tag/osx/" class="btn btn-default btn-xs">osx <span class='badge badge-secondary'>1</span></a> <a href="/tag/puppet/" class="btn btn-default btn-xs">puppet <span class='badge badge-secondary'>1</span></a> <a href="/tag/ruby/" class="btn btn-default btn-xs">ruby <span class='badge badge-secondary'>2</span></a> <a href="/tag/strategies/" class="btn btn-default btn-xs">strategies <span class='badge badge-secondary'>1</span></a> <a href="/tag/stubbes/" class="btn btn-default btn-xs">stubbes <span class='badge badge-secondary'>1</span></a> <a href="/tag/virtualbox/" class="btn btn-default btn-xs">virtualbox <span class='badge badge-secondary'>1</span></a> <a href="/tag/wordpress/" class="btn btn-default btn-xs">wordpress <span class='badge badge-secondary'>2</span></a> <hr/> Check accessibility with <a href="//wave.webaim.org/refer">WAVE</a>. [ c8d1196 ] </aside> </div> <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin=anonymous></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity=sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1 crossorigin=anonymous></script> <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin=anonymous></script> <script src="../../../assets/javascripts/all-ce8a433c.js"></script> <script>
      // Inject a title for this element that is created by SwifType
      $('#st-overlay-search-input').attr('title', 'search this website');
    </script> </body> </html>